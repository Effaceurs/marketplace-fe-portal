stages:
  - build
  - release


build:
  stage: build

  image:
    docker:20.10.13-alpine3.15

  services:
    - name: docker:20.10.13-dind-alpine3.15
      command: ["--insecure-registry=192.168.110.135:5000"]

  script:
    - ls -ltr
    - docker build -t "192.168.110.135:5000/portal:$CI_PIPELINE_ID" .
    - docker images 
    - docker push 192.168.110.135:5000/portal:$CI_PIPELINE_ID
    

release:
    image: 
        name: line/kubectl-kustomize:1.24.3-4.5.7
    stage: release
    before_script:
      - apk add git
      - git config --global user.name "${GITLAB_USER_NAME}"
      - git config --global user.email "${GITLAB_USER_EMAIL}"
    script:
      - mkdir manifests/release/ || echo 'already exists' 
      - cd manifests/base/ 
      - kustomize edit set image image=192.168.110.135:5000/portal:$CI_PIPELINE_ID
      - kustomize build > ../release/manifest.yaml
    after_script:
      - git remote set-url origin http://gitlab-ci-token:${ACCESS_TOKEN}@192.168.110.134/root/marketplace-fe-portal.git
      - git add manifests/release/manifest.yaml
      - git commit --allow-empty -m "build new version of app - ${CI_PIPELINE_ID}"
      - git push origin HEAD:main -o ci.skip


